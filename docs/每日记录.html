<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¯æ—¥è®¡åˆ’ï¼ˆå½©è‰²æ¸…æ™°ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --line: #e5e7eb;

      --work: #2563eb;   /* è“ */
      --study:#7c3aed;   /* ç´« */

      --urgent:#ef4444;  /* çº¢ */
      --normal:#10b981;  /* ç»¿ */

      --donebg:#ecfdf5;  /* æ·¡ç»¿ */
      --doneborder:#a7f3d0;
      --pendingbg:#ffffff;

      --shadow: 0 10px 30px rgba(17, 24, 39, .08);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1000px 500px at 15% 0%, rgba(37,99,235,.10), transparent 60%),
      radial-gradient(1000px 500px at 85% 0%, rgba(124,58,237,.10), transparent 60%),
      var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    .wrap{ max-width: 980px; margin: 0 auto; }
    h1{ margin: 0 0 8px; font-size: 24px; }
    .sub{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 14px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: #374151;
      white-space: nowrap;
    }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    input, select, button{
      padding: 11px 12px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: #9ca3af; }
    input[type="text"], input[type="url"]{ flex: 1; min-width: 220px; }
    select{ min-width: 120px; }
    button{ cursor:pointer; }
    button.primary{
      background: #111827;
      color: #fff;
      border-color: #111827;
    }
    button.primary:hover{ filter: brightness(1.05); }
    button.danger{
      background: #fff;
      border-color: rgba(239,68,68,.45);
      color: #b91c1c;
    }
    button.danger:hover{ background: rgba(239,68,68,.06); }
    button.ghost{ background: transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .row2{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
    .hint{ color: var(--muted); font-size: 12px; }
    .file{ display:none; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px; }

    .cardBox{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .cardBox h2{
      margin:0 0 10px;
      font-size: 16px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .count.work{ border-color: rgba(37,99,235,.25); color: var(--work); background: rgba(37,99,235,.08); }
    .count.study{ border-color: rgba(124,58,237,.25); color: var(--study); background: rgba(124,58,237,.08); }

    ul{ list-style:none; padding:0; margin:0; }

    /* ====== æ¯ä¸€è¡Œä»»åŠ¡ï¼šæ¸…æ™°ã€å½©è‰²ã€å¯¹æ¯”å¼º ====== */
    li.task{
      display:grid;
      grid-template-columns: 34px 1fr auto auto auto;
      gap: 10px;
      align-items:center;

      border-radius: 14px;
      padding: 12px 12px;
      margin: 10px 0;
      border: 1px solid var(--line);
      background: var(--pendingbg);
      position: relative;
      box-shadow: 0 8px 20px rgba(17,24,39,.06);
    }
    li.task:hover{ transform: translateY(-1px); transition: .12s; }

    li.task::before{
      content:"";
      position:absolute;
      left:0; top:10px; bottom:10px;
      width:7px;
      border-radius: 999px;
      background: #d1d5db;
    }

    /* ç±»åˆ«è‰²ï¼šå·¥ä½œ/å­¦ä¹ å†³å®šé»˜è®¤è‰²æ¡ */
    li.task.work::before{ background: rgba(37,99,235,.95); }
    li.task.study::before{ background: rgba(124,58,237,.95); }

    /* ç´§æ€¥è¦†ç›–ï¼šæ›´é†’ç›® */
    li.task.urgent::before{ background: rgba(239,68,68,.98); }

    /* æœªå®Œæˆï¼šæ ‡é¢˜æ›´ç²—æ›´é»‘ */
    li.task.pending .title{
      font-weight: 850;
      color: #111827;
    }
    li.task.pending{
      background: #fff7ed;
      border-color: #fdba74;
      box-shadow: 0 8px 22px rgba(251,146,60,.20);
    }
    li.task.pending::before{
      background: linear-gradient(180deg, rgba(251,146,60,.95), rgba(249,115,22,.95));
    }

    /* å·²å®Œæˆï¼šæ•´è¡Œæ·¡ç»¿åº• + ç°å­— + åˆ é™¤çº¿ + æ›´å¼±é˜´å½± */
    li.task.done{
      background: var(--donebg);
      border-color: var(--doneborder);
      box-shadow: 0 4px 12px rgba(16,185,129,.10);
      opacity: .90;
    }
    li.task.done .title{
      text-decoration: line-through;
      color: #6b7280;
      font-weight: 700;
    }

    .title{
      font-size: 15px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .meta{
      grid-column: 2 / span 4;
      color: var(--muted);
      font-size: 12px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: #374151;
      white-space: nowrap;
    }
    .badge.pending{ border-color: rgba(17,24,39,.18); background: #fff; }
    .task.pending .badge.pending{
      border-color: rgba(249,115,22,.45);
      background: rgba(249,115,22,.15);
      color: #9a3412;
      font-weight: 700;
    }
    .badge.done{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); color: #065f46; }
    .badge.urgent{ border-color: rgba(239,68,68,.40); background: rgba(239,68,68,.10); color: #991b1b; }

    .sectionLabel{
      margin: 10px 0 4px;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      color: #111827;
      background: #f3f4f6;
      border: 1px dashed var(--line);
    }
    .sectionLabel.pending{
      background: #fff7ed;
      border-color: rgba(249,115,22,.4);
      color: #9a3412;
    }
    .sectionLabel.done{
      background: #ecfdf5;
      border-color: rgba(16,185,129,.35);
      color: #065f46;
    }

    .btn{
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      white-space: nowrap;
    }
    .btn.open{
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      color: #1d4ed8;
    }
    .btn.del{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.06);
      color: #b91c1c;
    }

    .note{
      margin-top: 12px;
      color: #374151;
      font-size: 12px;
      border-left: 4px solid rgba(37,99,235,.55);
      padding-left: 10px;
    }

    /* æ‰‹æœºåªè¯»æŸ¥çœ‹æ¨¡å¼ */
    body.mobile-view .toolbar,
    body.mobile-view .row2,
    body.mobile-view .grid,
    body.mobile-view .note{
      display:none;
    }
    body.mobile-view #mobileView{
      display:block;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>æ¯æ—¥è®¡åˆ’ï¼ˆå½©è‰²æ¸…æ™°ç‰ˆï¼‰</h1>

  <div class="sub">
    <span id="todayText"></span>
    <span class="pill">å†å²æ—¥æœŸï¼š</span>
    <select id="datePicker"></select>
    <button class="ghost" id="goToday">å›åˆ°ä»Šå¤©</button>
  </div>

  <div class="toolbar">
    <select id="category">
      <option value="work">å·¥ä½œ</option>
      <option value="study">å­¦ä¹ </option>
    </select>

    <select id="priority">
      <option value="normal">ä¸ç´§æ€¥</option>
      <option value="urgent">ç´§æ€¥</option>
    </select>

    <input id="taskTitle" type="text" placeholder="äº‹é¡¹ï¼ˆä¾‹å¦‚ï¼šå†™å‘¨æŠ¥ / åˆ·ç®—æ³•ï¼‰" />
    <input id="taskLink" type="url" placeholder="å¯é€‰ï¼šå­¦ä¹ /èµ„æ–™é“¾æ¥ï¼ˆhttps://...ï¼‰" />
    <button class="primary" id="addBtn">æ·»åŠ </button>
    <button class="danger" id="clearDayBtn">æ¸…ç©ºå½“å¤©</button>
  </div>

  <div class="row2">
    <button id="exportBtn">å¯¼å‡ºå¤‡ä»½ï¼ˆJSONï¼‰</button>
    <button id="importBtn">å¯¼å…¥æ¢å¤ï¼ˆJSONï¼‰</button>
    <input class="file" id="importFile" type="file" accept="application/json" />
    <label class="pill">
      <input id="pendingOnlyToggle" type="checkbox" />
      ä»…çœ‹å¾…å®Œæˆ
    </label>
    <button id="exportIcsBtn">å¯¼å‡ºå­¦ä¹ æé†’ï¼ˆ23:00ï¼Œ30åˆ†é’Ÿï¼‰</button>
    <span class="hint">æç¤ºï¼šæ¸…æµè§ˆå™¨ç¼“å­˜ä¼šä¸¢æœ¬åœ°æ•°æ®ï¼›æƒ³å½»åº•ä¸ä¸¢è¯·å®šæœŸå¯¼å‡ºå¤‡ä»½ï¼Œæˆ–æ¥äº‘ç«¯ï¼ˆFirebase/Supabaseï¼‰ã€‚</span>
  </div>

  <div class="row2">
    <button id="makeMobileLinkBtn">ç”Ÿæˆæ‰‹æœºæŸ¥çœ‹é“¾æ¥</button>
    <input id="mobileLink" type="text" readonly placeholder="è¿™é‡Œä¼šç”Ÿæˆé“¾æ¥ï¼ˆç”¨äºæ‰‹æœºæŸ¥çœ‹å¾…å­¦ä¹ ï¼‰" />
    <button id="copyMobileLinkBtn">å¤åˆ¶é“¾æ¥</button>
    <span class="hint">22:55 è‡ªåŠ¨ç”Ÿæˆå¹¶å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆé…åˆ iPhone å¿«æ·æŒ‡ä»¤ 23:00 æ‰“å¼€ï¼‰ã€‚</span>
  </div>

  <div class="grid">
    <div class="cardBox">
      <h2>å·¥ä½œ <span class="pill count work" id="workCount">0</span></h2>
      <ul id="workList"></ul>
    </div>

    <div class="cardBox">
      <h2>å­¦ä¹  <span class="pill count study" id="studyCount">0</span></h2>
      <ul id="studyList"></ul>
    </div>
  </div>

  <div class="note">
    âœ… æ¯ä¸€è¡Œä»»åŠ¡ï¼šç™½åº•å¡ç‰‡ + å½©è‰²æ¡ + å¾½ç« ï¼ˆå¾…å®Œæˆ/å·²å®Œæˆ/ç´§æ€¥ï¼‰éå¸¸æ¸…æ™°ã€‚<br/>
    âœ… æ’åºï¼šç´§æ€¥æœªå®Œæˆç½®é¡¶ï¼Œå·²å®Œæˆæ²‰åº•ã€‚<br/>
    âœ… å†å²ï¼šæŒ‰æ—¥æœŸä¿å­˜ï¼›æ”¯æŒ JSON å¯¼å‡º/å¯¼å…¥å¤‡ä»½ã€‚
  </div>

  <div id="mobileView" class="cardBox" style="display:none;">
    <h2>ä»Šæ—¥å¾…å­¦ä¹ </h2>
    <ul id="mobileList"></ul>
    <div class="note" id="mobileNote"></div>
  </div>
</div>

<script>
  const STORAGE_KEY = "daily_planner_color_clear_v1";
  const el = (id) => document.getElementById(id);

  function pad(n){ return String(n).padStart(2, "0"); }
  function dateKey(d = new Date()){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function pretty(dkey){
    const [y,m,dd] = dkey.split("-");
    return `${y}å¹´${m}æœˆ${dd}æ—¥`;
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function escapeIcs(text){
    return String(text || "")
      .replace(/\\/g, "\\\\")
      .replace(/\n/g, "\\n")
      .replace(/,/g, "\\,")
      .replace(/;/g, "\\;");
  }
  function toIcsDate(dkey, hh, mm){
    return dkey.replace(/-/g, "") + "T" + pad(hh) + pad(mm) + "00";
  }
  function sanitizeUrl(url){
    if (!url) return "";
    try { return new URL(url).toString(); } catch { return ""; }
  }
  function encodePayload(obj){
    return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
  }
  function decodePayload(str){
    return JSON.parse(decodeURIComponent(escape(atob(str))));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { archives: {}, lastViewedDate: dateKey() };
      const s = JSON.parse(raw);
      if (!s.archives) s.archives = {};
      if (!s.lastViewedDate) s.lastViewedDate = dateKey();
      if (typeof s.showPendingOnly !== "boolean") s.showPendingOnly = false;
      if (!s.lastMobileLinkDate) s.lastMobileLinkDate = "";
      if (!s.lastMobileLink) s.lastMobileLink = "";
      if (!s.lastAlertDate) s.lastAlertDate = "";
      return s;
    }catch{
      return { archives: {}, lastViewedDate: dateKey() };
    }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function ensureDate(dkey){
    if(!state.archives[dkey]) state.archives[dkey] = [];
  }
  function getCurrentDate(){
    return el("datePicker").value || dateKey();
  }

  function refreshDatePicker(){
    const picker = el("datePicker");
    const keys = Object.keys(state.archives).sort().reverse();
    const today = dateKey();
    ensureDate(today);
    if (!keys.includes(today)) keys.unshift(today);

    picker.innerHTML = "";
    keys.forEach(k => {
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = k === today ? `ä»Šå¤© Â· ${pretty(k)}` : pretty(k);
      picker.appendChild(opt);
    });

    const target = state.lastViewedDate && (state.lastViewedDate in state.archives) ? state.lastViewedDate : today;
    picker.value = target;
  }

  function addTask(){
    const dkey = getCurrentDate();
    ensureDate(dkey);

    const category = el("category").value;
    const priority = el("priority").value;
    const title = el("taskTitle").value.trim();
    const link = sanitizeUrl(el("taskLink").value.trim());
    if(!title) return;

    state.archives[dkey].push({
      id: uid(),
      category,
      title,
      link,
      done: false,
      priority
    });

    el("taskTitle").value = "";
    el("taskLink").value = "";
    state.lastViewedDate = dkey;
    saveState();
    render();
  }

  function toggleDone(dkey, id){
    const t = state.archives[dkey].find(x => x.id === id);
    if(!t) return;
    t.done = !t.done;
    saveState();
    render();
  }

  function removeTask(dkey, id){
    state.archives[dkey] = state.archives[dkey].filter(x => x.id !== id);
    saveState();
    render();
  }

  function clearDay(){
    const dkey = getCurrentDate();
    if (!confirm(`ç¡®è®¤æ¸…ç©ºï¼š${pretty(dkey)} çš„æ‰€æœ‰äº‹é¡¹ï¼Ÿ`)) return;
    state.archives[dkey] = [];
    saveState();
    render();
  }

  function renderList(listEl, tasks, dkey){
    listEl.innerHTML = "";

    tasks.forEach(t => { if(!t.priority) t.priority = "normal"; });

    const pendingTasks = tasks
      .filter(t=>!t.done)
      .slice()
      .sort((a,b)=>{
        const ap = (a.priority === "urgent") ? 0 : 1;
        const bp = (b.priority === "urgent") ? 0 : 1;
        if (ap !== bp) return ap - bp;
        return 0;
      });
    const doneTasks = tasks.filter(t=>t.done);

    if (pendingTasks.length) {
      const label = document.createElement("li");
      label.className = "sectionLabel pending";
      label.textContent = `å¾…å®Œæˆ Â· ${pendingTasks.length} é¡¹`;
      listEl.appendChild(label);
    }

    pendingTasks.forEach(t=>{
        const li = document.createElement("li");
        li.className = `task ${t.category} ${t.done ? "done" : "pending"} ${t.priority || "normal"}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = t.done;
        checkbox.addEventListener("change", ()=>toggleDone(dkey, t.id));

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = t.title;

        const badge = document.createElement("span");
        badge.className = "badge " + (t.done ? "done" : "pending");
        badge.textContent = t.done ? "âœ… å·²å®Œæˆ" : "â¬œ å¾…å®Œæˆ";
        if (t.priority === "urgent") {
          badge.className += " urgent";
          badge.textContent = "ğŸ”¥ ç´§æ€¥ Â· " + badge.textContent;
        }

        const openBtn = document.createElement("button");
        openBtn.className = "btn open";
        openBtn.textContent = t.link ? "æ‰“å¼€é“¾æ¥" : "æ— é“¾æ¥";
        openBtn.disabled = !t.link;
        openBtn.addEventListener("click", ()=>{
          if(t.link) window.open(t.link, "_blank", "noopener,noreferrer");
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn del";
        delBtn.textContent = "åˆ é™¤";
        delBtn.addEventListener("click", ()=>removeTask(dkey, t.id));

        li.appendChild(checkbox);
        li.appendChild(title);
        li.appendChild(badge);
        li.appendChild(openBtn);
        li.appendChild(delBtn);

        if(t.link){
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = t.link;
          li.appendChild(meta);
        }

        listEl.appendChild(li);
    });

    if (doneTasks.length) {
      const label = document.createElement("li");
      label.className = "sectionLabel done";
      label.textContent = `å·²å®Œæˆ Â· ${doneTasks.length} é¡¹`;
      listEl.appendChild(label);
    }

    doneTasks.forEach(t=>{
      const li = document.createElement("li");
      li.className = `task ${t.category} done ${t.priority || "normal"}`;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;
      checkbox.addEventListener("change", ()=>toggleDone(dkey, t.id));

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = t.title;

      const badge = document.createElement("span");
      badge.className = "badge done";
      badge.textContent = "âœ… å·²å®Œæˆ";
      if (t.priority === "urgent") {
        badge.className += " urgent";
        badge.textContent = "ğŸ”¥ ç´§æ€¥ Â· " + badge.textContent;
      }

      const openBtn = document.createElement("button");
      openBtn.className = "btn open";
      openBtn.textContent = t.link ? "æ‰“å¼€é“¾æ¥" : "æ— é“¾æ¥";
      openBtn.disabled = !t.link;
      openBtn.addEventListener("click", ()=>{
        if(t.link) window.open(t.link, "_blank", "noopener,noreferrer");
      });

      const delBtn = document.createElement("button");
      delBtn.className = "btn del";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", ()=>removeTask(dkey, t.id));

      li.appendChild(checkbox);
      li.appendChild(title);
      li.appendChild(badge);
      li.appendChild(openBtn);
      li.appendChild(delBtn);

      if(t.link){
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = t.link;
        li.appendChild(meta);
      }

      listEl.appendChild(li);
    });
  }

  function render(){
    const dkey = getCurrentDate();
    ensureDate(dkey);

    el("todayText").textContent = `å½“å‰æŸ¥çœ‹ï¼š${pretty(dkey)}ï¼ˆä»Šæ—¥ï¼š${pretty(dateKey())}ï¼‰`;

    const tasks = state.archives[dkey];
    tasks.forEach(t => { if(!t.priority) t.priority = "normal"; });

    const workAll = tasks.filter(t=>t.category==="work");
    const studyAll = tasks.filter(t=>t.category==="study");

    const showPendingOnly = !!state.showPendingOnly;
    const work = showPendingOnly ? workAll.filter(t=>!t.done) : workAll;
    const study = showPendingOnly ? studyAll.filter(t=>!t.done) : studyAll;

    renderList(el("workList"), work, dkey);
    renderList(el("studyList"), study, dkey);

    const workPending = workAll.filter(t=>!t.done).length;
    const studyPending = studyAll.filter(t=>!t.done).length;
    el("workCount").textContent = `å¾…å®Œæˆ ${workPending}/${workAll.length}`;
    el("studyCount").textContent = `å¾…å®Œæˆ ${studyPending}/${studyAll.length}`;

    state.lastViewedDate = dkey;
    saveState();

    refreshDatePicker();
  }

  // å¯¼å‡º/å¯¼å…¥
  function exportJson(){
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `æ¯æ—¥è®¡åˆ’å¤‡ä»½_${dateKey()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function exportStudyIcs(){
    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//daily-planner//study-reminder//CN");
    lines.push("CALSCALE:GREGORIAN");

    const keys = Object.keys(state.archives).sort();
    const now = new Date();
    const dtstamp = `${now.getUTCFullYear()}${pad(now.getUTCMonth()+1)}${pad(now.getUTCDate())}T${pad(now.getUTCHours())}${pad(now.getUTCMinutes())}${pad(now.getUTCSeconds())}Z`;

    keys.forEach(k=>{
      const tasks = (state.archives[k] || []).filter(t=>t.category==="study" && !t.done);
      if (!tasks.length) return;
      const summary = `å­¦ä¹ å¾…å®Œæˆ ${tasks.length} é¡¹`;
      const desc = tasks.map(t=>`- ${t.title}`).join("\n");
      const start = toIcsDate(k, 23, 0);
      const end = toIcsDate(k, 23, 30);
      const uidStr = `${k.replace(/-/g,"")}-study-${uid()}@daily-planner`;

      lines.push("BEGIN:VEVENT");
      lines.push(`UID:${uidStr}`);
      lines.push(`DTSTAMP:${dtstamp}`);
      lines.push(`DTSTART:${start}`);
      lines.push(`DTEND:${end}`);
      lines.push(`SUMMARY:${escapeIcs(summary)}`);
      lines.push(`DESCRIPTION:${escapeIcs(desc)}`);
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");

    const ics = lines.join("\r\n");
    const blob = new Blob([ics], { type: "text/calendar" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `æ¯æ—¥å­¦ä¹ æé†’_2300_30min_${dateKey()}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function getPendingStudy(dkey){
    ensureDate(dkey);
    return (state.archives[dkey] || []).filter(t=>t.category==="study" && !t.done);
  }

  function buildMobileLink(dkey){
    const items = getPendingStudy(dkey).map(t=>({
      title: t.title,
      priority: t.priority || "normal"
    }));
    const payload = { date: dkey, items };
    const encoded = encodeURIComponent(encodePayload(payload));
    return `${location.origin}${location.pathname}#view=${encoded}`;
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      return false;
    }
  }

  async function generateMobileLink(opts = {}){
    const dkey = getCurrentDate();
    const link = buildMobileLink(dkey);
    el("mobileLink").value = link;
    state.lastMobileLink = link;
    state.lastMobileLinkDate = dkey;
    saveState();
    if (opts.copy) {
      await copyText(link);
    }
  }

  function renderMobileViewFromHash(){
    const hash = location.hash || "";
    if (!hash.startsWith("#view=")) return false;
    try{
      const raw = decodeURIComponent(hash.slice(6));
      const payload = decodePayload(raw);
      document.body.classList.add("mobile-view");

      const list = el("mobileList");
      list.innerHTML = "";
      const items = payload.items || [];
      if (!items.length) {
        const li = document.createElement("li");
        li.className = "task study done";
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = "âœ… ä»Šæ—¥å­¦ä¹ å·²å…¨éƒ¨å®Œæˆ";
        li.appendChild(document.createElement("span"));
        li.appendChild(title);
        list.appendChild(li);
      } else {
        items.forEach(item=>{
          const li = document.createElement("li");
          li.className = "task study pending " + (item.priority || "normal");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.disabled = true;
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = item.title;
          const badge = document.createElement("span");
          badge.className = "badge pending";
          badge.textContent = item.priority === "urgent" ? "ğŸ”¥ ç´§æ€¥ Â· å¾…å®Œæˆ" : "â¬œ å¾…å®Œæˆ";
          li.appendChild(checkbox);
          li.appendChild(title);
          li.appendChild(badge);
          list.appendChild(li);
        });
      }

      el("mobileNote").textContent = `åªè¯»æŸ¥çœ‹ï¼š${pretty(payload.date || dateKey())}`;
      return true;
    }catch{
      return false;
    }
  }

  function importJsonFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const incoming = JSON.parse(reader.result);
        if(!incoming || !incoming.archives) throw new Error("bad format");

        state = incoming;

        ensureDate(dateKey());
        Object.keys(state.archives).forEach(k=>{
          state.archives[k].forEach(t=>{
            if(!t.priority) t.priority = "normal";
            if(typeof t.done !== "boolean") t.done = false;
          });
        });

        if(!state.lastViewedDate) state.lastViewedDate = dateKey();
        saveState();
        render();
        alert("å¯¼å…¥æˆåŠŸ âœ…");
      }catch{
        alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸å¯¹ï¼ˆéœ€è¦æ˜¯æœ¬åº”ç”¨å¯¼å‡ºçš„ JSONï¼‰ã€‚");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  // åˆå§‹åŒ–
  let state = loadState();
  ensureDate(dateKey());

  if (!renderMobileViewFromHash()){
    el("pendingOnlyToggle").checked = !!state.showPendingOnly;
    if (state.lastMobileLink) el("mobileLink").value = state.lastMobileLink;
    refreshDatePicker();
    render();
  }

  el("addBtn").addEventListener("click", addTask);
  el("clearDayBtn").addEventListener("click", clearDay);
  el("datePicker").addEventListener("change", render);

  el("goToday").addEventListener("click", ()=>{
    el("datePicker").value = dateKey();
    render();
  });

  el("taskTitle").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTask(); });
  el("taskLink").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTask(); });

  el("exportBtn").addEventListener("click", exportJson);
  el("importBtn").addEventListener("click", ()=> el("importFile").click());
  el("pendingOnlyToggle").addEventListener("change", (e)=>{
    state.showPendingOnly = e.target.checked;
    saveState();
    render();
  });
  el("exportIcsBtn").addEventListener("click", exportStudyIcs);
  el("makeMobileLinkBtn").addEventListener("click", ()=>generateMobileLink({ copy: true }));
  el("copyMobileLinkBtn").addEventListener("click", async ()=>{
    const v = el("mobileLink").value.trim();
    if (!v) return;
    await copyText(v);
  });
  el("importFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importJsonFile(f);
    e.target.value = "";
  });

  // 22:55 è‡ªåŠ¨ç”Ÿæˆé“¾æ¥å¹¶å°è¯•å¤åˆ¶ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
  setInterval(async ()=>{
    const now = new Date();
    if (now.getHours() === 22 && now.getMinutes() === 55){
      const today = dateKey();
      if (state.lastMobileLinkDate !== today){
        await generateMobileLink({ copy: true });
      }
    }
  }, 30 * 1000);

  // 23:00 Mac å¼¹çª—æé†’ï¼ˆé¡µé¢éœ€ä¿æŒæ‰“å¼€ï¼‰
  setInterval(()=>{
    const now = new Date();
    if (now.getHours() === 23 && now.getMinutes() === 0){
      const today = dateKey();
      if (state.lastAlertDate !== today){
        const pending = getPendingStudy(today);
        if (pending.length){
          alert(`â° 23:00 å­¦ä¹ æé†’ï¼šè¿˜æœ‰ ${pending.length} é¡¹æœªå®Œæˆ\n\n` + pending.map(t=>`- ${t.title}`).join("\n"));
        } else {
          alert("âœ… 23:00 å­¦ä¹ æé†’ï¼šä»Šæ—¥å­¦ä¹ å·²å®Œæˆ");
        }
        state.lastAlertDate = today;
        saveState();
      }
    }
  }, 30 * 1000);
</script>
</body>
</html>
